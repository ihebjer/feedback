<!DOCTYPE html>
<html>
<head>
  <title>Review Your Diet</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .meal {
      margin-bottom: 20px;
    }
    .meal h3 {
      margin-bottom: 5px;
    }
    ul {
      padding-left: 20px;
    }
    .section {
      margin-top: 20px;
    }
    textarea {
      width: 100%;
    }
    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>Your Personalized Diet Plan</h1>
  <div id="diet-rendered">Loading diet...</div>

  <div class="section">
    <h2>Submit Your Feedback</h2>
    <form action="https://ihebjeridi.app.n8n.cloud/webhook/feedback" method="POST">
      <input type="hidden" name="sessionId" value="" id="sessionIdField" />
      <input type="hidden" name="diet" value="" id="dietField" />
      <textarea name="feedbackText" rows="6" placeholder="Write your feedback here..." required></textarea><br />
      <button type="submit">Submit Feedback</button>
    </form>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const dietEncoded = params.get("diet");
    const sessionId = params.get("sessionId");

    function renderDietPlan(dietObj) {
      const container = document.getElementById("diet-rendered");
      container.innerHTML = "";

      const goal = `<p><strong>Goal:</strong> ${dietObj.goal_summary}</p>`;
      const calories = `<p><strong>Daily Calorie Target:</strong> ${dietObj.calorie_target}</p>`;
      const total = `<p><strong>Total Estimated Calories:</strong> ${dietObj.meal_plan.total_estimated_calories}</p>`;

      const meals = dietObj.meal_plan.meals.map(meal => `
        <div class="meal">
          <h3>${meal.name} (${meal.approx_kcal})</h3>
          <ul>${meal.items.map(item => `<li>${item}</li>`).join('')}</ul>
        </div>
      `).join('');

      const nutrition = `
        <div class="section">
          <h3>Nutritional Considerations</h3>
          <ul>${dietObj.nutritional_considerations.map(n => `<li>${n}</li>`).join('')}</ul>
        </div>
      `;

      const message = `
        <div class="section">
          <h3>Motivational Message</h3>
          <p>${dietObj.motivational_message}</p>
        </div>
      `;

      const note = `
        <div class="section">
          <h3>Note</h3>
          <p>${dietObj.note}</p>
        </div>
      `;

      container.innerHTML = goal + calories + total + meals + nutrition + message + note;
    }

    if (dietEncoded) {
      try {
        const base64Decoded = atob(dietEncoded);
        const jsonDecoded = decodeURIComponent(base64Decoded);
        const dietObj = JSON.parse(jsonDecoded);
        renderDietPlan(dietObj);
        document.getElementById("dietField").value = jsonDecoded;
      } catch (e) {
        document.getElementById("diet-rendered").innerHTML = "<p class='error'>‚ùå Failed to parse diet JSON. Make sure it is correctly Base64 and URI encoded.</p>";
        console.error("Error decoding diet:", e);
      }
    }

    if (sessionId) {
      document.getElementById("sessionIdField").value = sessionId;
    }
  </script>

</body>
</html>
